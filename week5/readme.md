# 第五周作业

## 题目要求

设计一个新的容错机制，同步转异步的容错机制。当满足以下两个条件中的任何一个时，将请求转储到数据库，后续再另外启动一个 goroutine 异步发送出去。

- 触发了限流。
- 判定服务商已经崩溃。

**要求：**

- **如何判定服务商已经崩溃，不允许使用课程上的判断机制，你需要设计一个新的判断机制，并且解释这种判定机制的决策理由。**
- **控制异步重试次数，转储到数据库之后，可以重试 N 次，重试间隔你可以自由决策。**
- **不允许写死任何参数，即用户必须可以控制控制参数。**
- 保持面向接口和依赖注入风格。
- 写明这种容错机制适合什么场景，并且有什么优缺点。
- 针对提出的缺点，写出后续的改进方案。
- 提供单元测试。
- 设计方案的时候，不允许问老师、助教。即方案肯定得你自己设计，包括优缺点分析、改进方向必须独立完成。

## 设计方案

### 服务商崩溃判断机制设计

使用断路器模式,实现有三种状态:

* 关闭（Closed)：调用正常执行。断路器组件对最近失败的调用进行计数，当达到阈值时，则断路器组件“跳闸”，进入“打开”状态。
* 打开（Open）：调用请求会立即失败，断路器组件抛出异常。
* 半打开（Half-Open）：当处于“打开”状态时，会启动一个超时定时器，当超时后，断路器组件会进入“半打开”状态，
此时允许执行部分调用，断路器会对成功执行的调用进行计数，达到阈值后，会认为被调用服务恢复正常，断路器状态回到“关闭”状态，
如果有请求出现失败，则回到“打开”状态。

### 容错设计的优缺点

优点：

熔断器模式，为重新恢复，制定了一个稳妥的缓慢的验证恢复过程，避免了在故障时期的无效的重试。

缺点：

进入打开状态的一段时间是直接返回异常的，如果这个时期服务恢复了，就没法立刻感知到。

## 代码实现

1. [跳转到熔断器实现](./webook/internal/service/sms/circuit_breaker/circuit_breaker.go)
1. [异步存储后异步重试发送实现](./webook/internal/service/sms/failover/async_failover.go)

## 单元测试

1. [跳转到熔断器实现测试用例](./webook/internal/service/sms/circuit_breaker/circuit_breaker_test.go)
1. [异步存储后异步重试发送实现测试用例](./webook/internal/service/sms/failover/async_failover_test.go)


